<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1f2937">
    <meta name="description" content="Secure 2FA Authenticator - Offline & PWA">
    <title>My2FA - Authenticator</title>
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22My2FA%22,%22short_name%22:%222FA%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%231f2937%22,%22theme_color%22:%22%2310b981%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 192 192%27%3E%3Crect fill=%27%2310b981%27 width=%27192%27 height=%27192%27/%3E%3Ctext x=%2796%27 y=%27120%27 font-size=%2780%27 font-weight=%27bold%27 fill=%27white%27 text-anchor=%27middle%272FA%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22any%22}]}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --bg-dark: #111827;
            --bg-card-dark: #1f2937;
            --bg-input-dark: #374151;
            --text-dark: #f3f4f6;
            --text-muted-dark: #9ca3af;
            --border-dark: #4b5563;
            --error: #f97316;
            --warning: #eab308;
            --success: #10b981;
            
            --bg-light: #f9fafb;
            --bg-card-light: #ffffff;
            --bg-input-light: #f3f4f6;
            --text-light: #111827;
            --text-muted-light: #6b7280;
            --border-light: #e5e7eb;

            --bg: var(--bg-dark);
            --bg-card: var(--bg-card-dark);
            --bg-input: var(--bg-input-dark);
            --text: var(--text-dark);
            --text-muted: var(--text-muted-dark);
            --border: var(--border-dark);
        }

        html.light-mode {
            --bg: var(--bg-light);
            --bg-card: var(--bg-card-light);
            --bg-input: var(--bg-input-light);
            --text: var(--text-light);
            --text-muted: var(--text-muted-light);
            --border: var(--border-light);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-top: 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--border);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-container {
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--bg-input);
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .codes-container {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }

        .code-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 16px;
            align-items: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .code-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        .code-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background-color: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .code-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .code-icon-placeholder {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .code-info {
            flex: 1;
            min-width: 0;
        }

        .code-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .code-account {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .code-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }

        .code-value {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--primary);
            user-select: all;
        }

        .code-timer-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-timer {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            min-width: 24px;
            text-align: right;
            transition: color 0.2s ease;
        }

        .code-timer.warning {
            color: var(--warning);
        }

        .code-timer.critical {
            color: var(--error);
        }

        .progress-bar {
            width: 32px;
            height: 4px;
            background-color: var(--bg-input);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            border-radius: 2px;
            transition: background-color 0.2s ease;
            width: 100%;
        }

        .progress-fill.warning {
            background-color: var(--warning);
        }

        .progress-fill.critical {
            background-color: var(--error);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 24px;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background-color: var(--bg-input);
            color: var(--text);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--bg-input);
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .form-actions .btn {
            flex: 1;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: var(--bg-card);
            color: var(--text);
            padding: 16px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            z-index: 2000;
            max-width: 400px;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .settings-group {
            margin-bottom: 24px;
        }

        .settings-group-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .settings-item-label {
            font-size: 14px;
            font-weight: 500;
        }

        .toggle {
            width: 48px;
            height: 28px;
            background-color: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle.active {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .toggle-dot {
            width: 22px;
            height: 22px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s ease;
        }

        .toggle.active .toggle-dot {
            left: 22px;
        }

        @media (max-width: 480px) {
            .header {
                margin-bottom: 24px;
            }

            .header h1 {
                font-size: 24px;
            }

            .code-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .code-display {
                align-items: flex-start;
                width: 100%;
            }

            .code-value {
                font-size: 18px;
            }

            .toast {
                right: 16px;
                left: 16px;
                bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>My2FA</h1>
            <div class="header-actions">
                <button class="btn btn-icon btn-secondary" id="themeToggle" title="Toggle theme">
                    <span id="themeIcon">üåô</span>
                </button>
                <button class="btn btn-icon btn-secondary" id="settingsBtn" title="Settings">
                    ‚öôÔ∏è
                </button>
                <button class="btn btn-primary" id="addCodeBtn">
                    + Add Code
                </button>
            </div>
        </div>

        <div class="search-container">
            <input 
                type="text" 
                class="search-input" 
                id="searchInput" 
                placeholder="Search codes by name or account..."
            >
        </div>

        <div class="codes-container" id="codesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üîê</div>
                <div class="empty-state-title">No codes yet</div>
                <div class="empty-state-text">Add your first 2FA code to get started</div>
                <button class="btn btn-primary" id="emptyAddBtn">Add Code</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Code Modal -->
    <div class="modal" id="addCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">Add 2FA Code</span>
                <button class="modal-close" id="closeAddModal">&times;</button>
            </div>
            <form id="addCodeForm">
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" class="form-input" id="serviceName" placeholder="e.g., Gmail, GitHub" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Account</label>
                    <input type="text" class="form-input" id="accountName" placeholder="e.g., user@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Secret Key</label>
                    <input type="text" class="form-input" id="secretKey" placeholder="Paste your secret key here" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Algorithm</label>
                    <select class="form-input" id="algorithm">
                        <option value="SHA1">SHA1 (Default)</option>
                        <option value="SHA256">SHA256</option>
                        <option value="SHA512">SHA512</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAddBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Code</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Settings</span>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Appearance</div>
                <div class="settings-item">
                    <span class="settings-item-label">Dark Mode</span>
                    <div class="toggle" id="darkModeToggle">
                        <div class="toggle-dot"></div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Security</div>
                <div class="settings-item">
                    <span class="settings-item-label">PIN Protection</span>
                    <div class="toggle" id="pinToggle">
                        <div class="toggle-dot"></div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Backup</div>
                <button class="btn btn-secondary" style="width: 100%; justify-content: center;" id="exportBtn">
                    üì• Export Backup
                </button>
                <button class="btn btn-secondary" style="width: 100%; justify-content: center; margin-top: 8px;" id="importBtn">
                    üì§ Import Backup
                </button>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Danger Zone</div>
                <button class="btn btn-secondary" style="width: 100%; justify-content: center; color: var(--error);" id="clearAllBtn">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="modal" id="pinModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="pinModalTitle">Enter PIN</span>
                <button class="modal-close" id="closePinModal">&times;</button>
            </div>
            <form id="pinForm">
                <div class="form-group">
                    <label class="form-label">4-Digit PIN</label>
                    <input type="password" class="form-input" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelPinBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Verify</button>
                </div>
            </form>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json" style="display: none;">

    <script>
        // ============ UTILITIES ============
        const Utils = {
            base32Decode(str) {
                const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                let bits = '';
                for (let i = 0; i < str.length; i++) {
                    const val = alphabet.indexOf(str[i].toUpperCase());
                    if (val === -1) throw new Error('Invalid base32 character');
                    bits += val.toString(2).padStart(5, '0');
                }
                const bytes = [];
                for (let i = 0; i + 8 <= bits.length; i += 8) {
                    bytes.push(parseInt(bits.substr(i, 8), 2));
                }
                return new Uint8Array(bytes);
            },

            async generateTOTP(secret, algorithm = 'SHA1') {
                const key = this.base32Decode(secret);
                const time = Math.floor(Date.now() / 1000 / 30);
                const timeBuffer = new ArrayBuffer(8);
                const view = new DataView(timeBuffer);
                view.setBigInt64(0, BigInt(time), false);

                const algoMap = {
                    'SHA1': 'SHA-1',
                    'SHA256': 'SHA-256',
                    'SHA512': 'SHA-512'
                };

                const signature = await crypto.subtle.sign(
                    { name: 'HMAC', hash: algoMap[algorithm] },
                    await crypto.subtle.importKey('raw', key, { name: 'HMAC', hash: algoMap[algorithm] }, false, ['sign']),
                    timeBuffer
                );

                const signatureArray = new Uint8Array(signature);
                const offset = signatureArray[signatureArray.length - 1] & 0xf;
                const code = (
                    ((signatureArray[offset] & 0x7f) << 24) |
                    ((signatureArray[offset + 1] & 0xff) << 16) |
                    ((signatureArray[offset + 2] & 0xff) << 8) |
                    (signatureArray[offset + 3] & 0xff)
                ) % 1000000;

                return code.toString().padStart(6, '0');
            },

            getTimeRemaining() {
                return 30 - (Math.floor(Date.now() / 1000) % 30);
            },

            getProgress() {
                return (this.getTimeRemaining() / 30) * 100;
            },

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        // ============ STORAGE ============
        const Storage = {
            get() {
                const data = localStorage.getItem('2fa_codes');
                return data ? JSON.parse(data) : [];
            },

            save(codes) {
                localStorage.setItem('2fa_codes', JSON.stringify(codes));
            },

            getSettings() {
                const settings = localStorage.getItem('2fa_settings');
                return settings ? JSON.parse(settings) : {
                    darkMode: true,
                    pinEnabled: false,
                    pin: null
                };
            },

            saveSettings(settings) {
                localStorage.setItem('2fa_settings', JSON.stringify(settings));
            }
        };

        // ============ APP STATE ============
        let appState = {
            codes: Storage.get(),
            settings: Storage.getSettings(),
            filteredCodes: [],
            editingId: null,
            updateIntervals: new Map()
        };

        // ============ THEME ============
        function initTheme() {
            const isDark = appState.settings.darkMode;
            if (!isDark) {
                document.documentElement.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            appState.settings.darkMode = !appState.settings.darkMode;
            Storage.saveSettings(appState.settings);
            
            if (appState.settings.darkMode) {
                document.documentElement.classList.remove('light-mode');
                document.getElementById('themeIcon').textContent = 'üåô';
            } else {
                document.documentElement.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        // ============ RENDERING ============
        async function renderCodes() {
            const container = document.getElementById('codesContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            appState.filteredCodes = appState.codes.filter(code => 
                code.name.toLowerCase().includes(searchTerm) ||
                code.account.toLowerCase().includes(searchTerm)
            );

            if (appState.filteredCodes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${searchTerm ? 'üîç' : 'üîê'}</div>
                        <div class="empty-state-title">${searchTerm ? 'No codes found' : 'No codes yet'}</div>
                        <div class="empty-state-text">${searchTerm ? 'Try a different search' : 'Add your first 2FA code to get started'}</div>
                        ${!searchTerm ? '<button class="btn btn-primary" id="emptyAddBtn">Add Code</button>' : ''}
                    </div>
                `;
                if (!searchTerm) {
                    document.getElementById('emptyAddBtn').addEventListener('click', () => openAddModal());
                }
                return;
            }

            container.innerHTML = appState.filteredCodes.map(code => `
                <div class="code-item" data-id="${code.id}">
                    <div class="code-icon">
                        <img src="https://logo.clearbit.com/${encodeURIComponent(code.name.toLowerCase())}.com?size=48" 
                             alt="${code.name}" 
                             onerror="this.parentElement.innerHTML='<div class=code-icon-placeholder>${code.name.charAt(0).toUpperCase()}</div>'">
                    </div>
                    <div class="code-info">
                        <div class="code-name">${code.name}</div>
                        <div class="code-account">${code.account || 'No account'}</div>
                    </div>
                    <div class="code-display">
                        <div class="code-value" data-code-id="${code.id}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                        <div class="code-timer-container">
                            <div class="code-timer" data-timer-id="${code.id}">30s</div>
                            <div class="progress-bar">
                                <div class="progress-fill" data-progress-id="${code.id}" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add event listeners
            appState.filteredCodes.forEach(code => {
                const item = container.querySelector(`[data-id="${code.id}"]`);
                item.addEventListener('click', () => copyCode(code.id));
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    deleteCode(code.id);
                });
            });

            // Start smooth updates for each code
            appState.filteredCodes.forEach(code => {
                updateCodeDisplay(code.id);
            });
        }

        async function updateCodeDisplay(codeId) {
            // Clear existing interval
            if (appState.updateIntervals.has(codeId)) {
                clearInterval(appState.updateIntervals.get(codeId));
            }

            const code = appState.codes.find(c => c.id === codeId);
            if (!code) return;

            // Update immediately
            await updateCodeValues(codeId);

            // Update every 100ms for smooth progress bar
            const interval = setInterval(() => updateCodeValues(codeId), 100);
            appState.updateIntervals.set(codeId, interval);
        }

        async function updateCodeValues(codeId) {
            const code = appState.codes.find(c => c.id === codeId);
            if (!code) return;

            const codeElement = document.querySelector(`[data-code-id="${codeId}"]`);
            const timerElement = document.querySelector(`[data-timer-id="${codeId}"]`);
            const progressElement = document.querySelector(`[data-progress-id="${codeId}"]`);

            if (!codeElement || !timerElement || !progressElement) return;

            // Generate TOTP code
            const totpCode = await Utils.generateTOTP(code.secret, code.algorithm || 'SHA1');
            codeElement.textContent = totpCode;

            // Update timer and progress
            const timeRemaining = Utils.getTimeRemaining();
            const progress = Utils.getProgress();

            timerElement.textContent = `${timeRemaining}s`;
            progressElement.style.width = `${progress}%`;

            // <CHANGE> Smooth color transitions based on time remaining
            if (timeRemaining <= 5) {
                timerElement.classList.add('critical');
                progressElement.classList.add('critical');
            } else if (timeRemaining <= 10) {
                timerElement.classList.remove('critical');
                timerElement.classList.add('warning');
                progressElement.classList.remove('critical');
                progressElement.classList.add('warning');
            } else {
                timerElement.classList.remove('critical', 'warning');
                progressElement.classList.remove('critical', 'warning');
            }
        }

        async function copyCode(codeId) {
            const code = appState.codes.find(c => c.id === codeId);
            if (!code) return;

            const totpCode = await Utils.generateTOTP(code.secret, code.algorithm || 'SHA1');
            await navigator.clipboard.writeText(totpCode);
            Utils.showToast('Code copied to clipboard!', 'success');
        }

        // ============ MODALS ============
        function openAddModal(id = null) {
            appState.editingId = id;
            const modal = document.getElementById('addCodeModal');
            const form = document.getElementById('addCodeForm');
            const title = document.getElementById('modalTitle');

            if (id) {
                const code = appState.codes.find(c => c.id === id);
                title.textContent = 'Edit 2FA Code';
                document.getElementById('serviceName').value = code.name;
                document.getElementById('accountName').value = code.account;
                document.getElementById('secretKey').value = code.secret;
                document.getElementById('algorithm').value = code.algorithm || 'SHA1';
            } else {
                title.textContent = 'Add 2FA Code';
                form.reset();
            }

            modal.classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addCodeModal').classList.remove('active');
            appState.editingId = null;
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            
            // Update toggle states
            const darkModeToggle = document.getElementById('darkModeToggle');
            const pinToggle = document.getElementById('pinToggle');

            if (appState.settings.darkMode) {
                darkModeToggle.classList.add('active');
            } else {
                darkModeToggle.classList.remove('active');
            }

            if (appState.settings.pinEnabled) {
                pinToggle.classList.add('active');
            } else {
                pinToggle.classList.remove('active');
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // ============ CODE MANAGEMENT ============
        function addOrUpdateCode(e) {
            e.preventDefault();

            const name = document.getElementById('serviceName').value.trim();
            const account = document.getElementById('accountName').value.trim();
            const secret = document.getElementById('secretKey').value.trim().toUpperCase().replace(/\s/g, '');
            const algorithm = document.getElementById('algorithm').value;

            if (!name || !secret) {
                Utils.showToast('Please fill in all required fields', 'error');
                return;
            }

            try {
                Utils.base32Decode(secret);
            } catch (err) {
                Utils.showToast('Invalid secret key format', 'error');
                return;
            }

            if (appState.editingId) {
                const code = appState.codes.find(c => c.id === appState.editingId);
                code.name = name;
                code.account = account;
                code.secret = secret;
                code.algorithm = algorithm;
                Utils.showToast('Code updated successfully', 'success');
            } else {
                appState.codes.push({
                    id: Date.now().toString(),
                    name,
                    account,
                    secret,
                    algorithm,
                    createdAt: new Date().toISOString()
                });
                Utils.showToast('Code added successfully', 'success');
            }

            Storage.save(appState.codes);
            closeAddModal();
            renderCodes();
        }

        function deleteCode(id) {
            if (confirm('Are you sure you want to delete this code?')) {
                appState.codes = appState.codes.filter(c => c.id !== id);
                if (appState.updateIntervals.has(id)) {
                    clearInterval(appState.updateIntervals.get(id));
                    appState.updateIntervals.delete(id);
                }
                Storage.save(appState.codes);
                Utils.showToast('Code deleted', 'success');
                renderCodes();
            }
        }

        // ============ BACKUP & RESTORE ============
        function exportBackup() {
            const backup = {
                version: 1,
                exportDate: new Date().toISOString(),
                codes: appState.codes
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `2fa-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            Utils.showToast('Backup exported successfully', 'success');
        }

        function importBackup() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const backup = JSON.parse(event.target.result);
                    if (!backup.codes || !Array.isArray(backup.codes)) {
                        throw new Error('Invalid backup format');
                    }

                    appState.codes = [...appState.codes, ...backup.codes];
                    Storage.save(appState.codes);
                    Utils.showToast('Backup imported successfully', 'success');
                    renderCodes();
                } catch (err) {
                    Utils.showToast('Failed to import backup: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // ============ EVENT LISTENERS ============
        document.getElementById('addCodeBtn').addEventListener('click', () => openAddModal());
        document.getElementById('emptyAddBtn')?.addEventListener('click', () => openAddModal());
        document.getElementById('closeAddModal').addEventListener('click', closeAddModal);
        document.getElementById('cancelAddBtn').addEventListener('click', closeAddModal);
        document.getElementById('addCodeForm').addEventListener('submit', addOrUpdateCode);

        document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
        document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        document.getElementById('darkModeToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            toggleTheme();
        });

        document.getElementById('exportBtn').addEventListener('click', exportBackup);
        document.getElementById('importBtn').addEventListener('click', importBackup);

        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('Are you sure? This will delete all codes permanently.')) {
                appState.codes = [];
                Storage.save(appState.codes);
                appState.updateIntervals.forEach(interval => clearInterval(interval));
                appState.updateIntervals.clear();
                Utils.showToast('All data cleared', 'success');
                renderCodes();
            }
        });

        document.getElementById('searchInput').addEventListener('input', renderCodes);

        // Close modals on outside click
        document.getElementById('addCodeModal').addEventListener('click', (e) => {
            if (e.target.id === 'addCodeModal') closeAddModal();
        });

        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') closeSettingsModal();
        });

        // ============ INITIALIZATION ============
        initTheme();
        renderCodes();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'my2fa-v1';
                const urlsToCache = ['/'];

                self.addEventListener('install', event => {
                    event.waitUntil(caches.open(CACHE_NAME));
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => {
                            return response || fetch(event.request).catch(() => {
                                return new Response('Offline');
                            });
                        })
                    );
                });
            `;

            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch(() => {});
        }
    </script>
</body>
</html>